<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor CSV Seguro</title>
    <!-- Usar HTTPS para evitar problemas de mixed content -->
    <link rel="icon" href="data:,">
    <style>
        /* (Mantener los estilos anteriores) */
    </style>
</head>
<body>
    <!-- (Mantener la estructura HTML anterior) -->

    <script>
        // Configuración
        const CONFIG = {
            repoOwner: 'TU_USUARIO_GITHUB',
            repoName: 'TU_REPOSITORIO',
            fileName: 'datos.csv',
            defaultContent: 'Nombre,Apellido,Edad\nEjemplo,Usuario,30'
        };

        // Elementos del DOM
        const dataInput = document.getElementById('dataInput');
        const loadButton = document.getElementById('loadButton');
        const saveButton = document.getElementById('saveButton');
        const statusDiv = document.getElementById('status');

        // Estado de la aplicación
        let currentSha = null;
        let githubToken = null;
        let useSessionStorage = false;

        // Inicialización segura
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Prueba de acceso a storage
                const testKey = 'storage_test';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
            } catch (e) {
                console.warn("localStorage no disponible, usando sessionStorage");
                useSessionStorage = true;
            }

            await checkToken();
        });

        // Gestión del token mejorada
        async function checkToken() {
            try {
                githubToken = useSessionStorage 
                    ? sessionStorage.getItem('github_token')
                    : localStorage.getItem('github_token');
                
                if (!githubToken) {
                    await requestToken();
                } else {
                    await loadFileContent();
                }
            } catch (error) {
                showStatus("Error al cargar configuración: " + error.message, "error");
                dataInput.value = CONFIG.defaultContent;
            }
        }

        async function requestToken() {
            showStatus("Se requiere autenticación", "warning");
            
            // Crear interfaz para token sin usar prompt()
            const tokenDialog = document.createElement('div');
            tokenDialog.style.position = 'fixed';
            tokenDialog.style.top = '0';
            tokenDialog.style.left = '0';
            tokenDialog.style.width = '100%';
            tokenDialog.style.height = '100%';
            tokenDialog.style.backgroundColor = 'rgba(0,0,0,0.5)';
            tokenDialog.style.display = 'flex';
            tokenDialog.style.justifyContent = 'center';
            tokenDialog.style.alignItems = 'center';
            tokenDialog.style.zIndex = '1000';
            
            tokenDialog.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px;">
                    <h2 style="margin-top: 0;">Autenticación requerida</h2>
                    <p>Ingresa tu token de acceso GitHub (con permisos repo):</p>
                    <input type="password" id="tokenInput" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
                    <button id="submitToken" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px;">Enviar</button>
                    <p><small>Crea un token en <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a></small></p>
                </div>
            `;
            
            document.body.appendChild(tokenDialog);
            
            return new Promise((resolve) => {
                document.getElementById('submitToken').addEventListener('click', () => {
                    githubToken = document.getElementById('tokenInput').value.trim();
                    if (githubToken) {
                        try {
                            if (useSessionStorage) {
                                sessionStorage.setItem('github_token', githubToken);
                            } else {
                                localStorage.setItem('github_token', githubToken);
                            }
                        } catch (e) {
                            console.warn("No se pudo persistir el token", e);
                        }
                        tokenDialog.remove();
                        loadFileContent();
                        resolve();
                    }
                });
            });
        }

        // (Mantener las demás funciones igual que en el ejemplo anterior)
        // loadFileContent(), saveFileContent(), etc...
        
        // Función para verificar HTTPS
        function ensureSecureContext() {
            if (window.isSecureContext) {
                return true;
            } else {
                showStatus("Advertencia: No estás en un contexto seguro (HTTPS)", "warning");
                return false;
            }
        }
    </script>
</body>
</html>
